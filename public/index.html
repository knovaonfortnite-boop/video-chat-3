<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini FaceTime Chat</title>
<style>
body { background:#000; color:#fff; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; padding:20px;}
#participants, #chat { margin-bottom:10px; width:100%; max-width:600px; }
#videoContainer { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px; }
.video-wrapper { position:relative; background:#222; width:100%; padding-top:56.25%; border-radius:8px; overflow:hidden; }
video { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; }
.video-label { position:absolute; bottom:4px; left:4px; background:rgba(0,0,0,0.6); padding:2px 6px; border-radius:4px; font-size:14px; }
button { margin:5px; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600; }
#chatBox { width:100%; height:150px; background:#111; overflow-y:auto; padding:8px; border-radius:6px; margin-bottom:5px; }
#chatInput { width:80%; padding:6px; border-radius:6px; border:none; }
#sendBtn { padding:6px 12px; }
</style>
</head>
<body>
<h1>Mini FaceTime Chat</h1>
<div id="participants"></div>
<div id="videoContainer">
  <div class="video-wrapper" id="localWrapper">
    <video id="localVideo" autoplay muted playsinline></video>
    <div class="video-label" id="localLabel">You</div>
  </div>
</div>

<div>
  <button id="startBtn">Start Camera</button>
  <button id="toggleCamBtn" disabled>Turn Camera Off</button>
  <button id="joinBtn" disabled>Join Call</button>
  <button id="leaveBtn" disabled>Leave Call</button>
</div>

<div id="chat">
  <div id="chatBox"></div>
  <input type="text" id="chatInput" placeholder="Message..."/>
  <button id="sendBtn">Send</button>
</div>

<script>
let ws, localStream, myId, camOn=true;
const peerConnections=new Map();
const remoteVideos=new Map();
const videoContainer=document.getElementById('videoContainer');
const localVideo=document.getElementById('localVideo');
const localLabel=document.getElementById('localLabel');
const localWrapper=document.getElementById('localWrapper');
const startBtn=document.getElementById('startBtn');
const toggleCamBtn=document.getElementById('toggleCamBtn');
const joinBtn=document.getElementById('joinBtn');
const leaveBtn=document.getElementById('leaveBtn');
const participantsDiv=document.getElementById('participants');
const chatBox=document.getElementById('chatBox');
const chatInput=document.getElementById('chatInput');
const sendBtn=document.getElementById('sendBtn');

function updateParticipants() {
  participantsDiv.innerHTML='';
  for (const [id, pc] of peerConnections) {
    const div=document.createElement('div');
    div.textContent=pc.username||id.substring(0,4);
    div.dataset.id=id;
    div.style.cursor='pointer';
    div.onclick=()=>chatInput.dataset.to=id;
    participantsDiv.appendChild(div);
  }
}

function addChatMessage(from, msg) {
  const div=document.createElement('div');
  div.textContent=`${from}: ${msg}`;
  chatBox.appendChild(div);
  chatBox.scrollTop=chatBox.scrollHeight;
}

async function startCamera(){
  const username=prompt("Enter your name:");
  if(!username)return alert("You must enter a name!");
  localLabel.textContent=username;
  try {
    localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    localVideo.srcObject=localStream;
    startBtn.disabled=true; toggleCamBtn.disabled=false;
    connectWebSocket(username);
  } catch(e){console.error(e);}
}

toggleCamBtn.addEventListener('click', ()=>{
  camOn=!camOn;
  localStream.getVideoTracks()[0].enabled=camOn;
  toggleCamBtn.textContent=camOn?"Turn Camera Off":"Turn Camera On";
  localVideo.style.display=camOn?"block":"none";
  if(!camOn)localWrapper.style.background='#'+Math.floor(Math.random()*16777215).toString(16);
  else localWrapper.style.background='#222';
});

joinBtn.addEventListener('click', ()=>{
  joinBtn.disabled=true; leaveBtn.disabled=false;
  ws.send(JSON.stringify({type:'join'}));
});

leaveBtn.addEventListener('click', ()=>{
  ws.send(JSON.stringify({type:'leave'}));
  peerConnections.forEach(pc=>pc.pc.close());
  peerConnections.clear();
  remoteVideos.forEach(e=>e.remove());
  remoteVideos.clear();
  joinBtn.disabled=false; leaveBtn.disabled=true;
  updateParticipants();
});

sendBtn.addEventListener('click', ()=>{
  const msg=chatInput.value.trim();
  if(!msg)return;
  const to=chatInput.dataset.to;
  ws.send(JSON.stringify({type:'text',message:msg,to:to||null}));
  addChatMessage("You",msg);
  chatInput.value='';
});

function connectWebSocket(username){
  ws=new WebSocket(`wss://${window.location.host}`);
  ws.onopen=()=>joinBtn.disabled=false;
  ws.onmessage=async(e)=>{
    const msg=JSON.parse(e.data);
    switch(msg.type){
      case 'welcome': myId=msg.id; break;
      case 'existing-participants':
        for(const p of msg.participants){await createPeerConnection(p.id,false,p.username);}
        updateParticipants(); break;
      case 'new-participant': await createPeerConnection(msg.id,true,msg.username); updateParticipants(); break;
      case 'offer': await handleOffer(msg.offer,msg.from); break;
      case 'answer': await handleAnswer(msg.answer,msg.from); break;
      case 'ice-candidate': await handleIceCandidate(msg.candidate,msg.from); break;
      case 'participant-left': handleParticipantLeft(msg.id); updateParticipants(); break;
      case 'text': addChatMessage(msg.username,msg.message); break;
    }
  };
  ws.onclose=()=>console.log("Disconnected");
  ws.onerror=console.error;
  ws.onopen=()=>ws.send(JSON.stringify({type:'set-username',username}));
}

async function createPeerConnection(peerId,isInitiator,username){
  const pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  pc.username=username;
  peerConnections.set(peerId,{pc,username});
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.ontrack=e=>addRemoteVideo(peerId,e.streams[0],username);
  pc.onicecandidate=e=>{if(e.candidate)ws.send(JSON.stringify({type:'ice-candidate',candidate:e.candidate,to:peerId}));};
  if(isInitiator){
    const offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    ws.send(JSON.stringify({type:'offer',offer,to:peerId}));
  }
}

async function handleOffer(offer,fromId){
  let pcData=peerConnections.get(fromId);
  if(!pcData){await createPeerConnection(fromId,false); pcData=peerConnections.get(fromId);}
  await pcData.pc.setRemoteDescription(new RTCSessionDescription(offer));
  const answer=await pcData.pc.createAnswer();
  await pcData.pc.setLocalDescription(answer);
  ws.send(JSON.stringify({type:'answer',answer,to:fromId}));
}

async function handleAnswer(answer,fromId){
  const pcData=peerConnections.get(fromId);
  if(pcData)await pcData.pc.setRemoteDescription(new RTCSessionDescription(answer));
}

async function handleIceCandidate(candidate,fromId){
  const pcData=peerConnections.get(fromId);
  if(pcData)await pcData.pc.addIceCandidate(new RTCIceCandidate(candidate));
}

function addRemoteVideo(peerId,stream,username){
  if(remoteVideos.has(peerId))return;
  const wrapper=document.createElement('div'); wrapper.className='video-wrapper'; wrapper.id=`video-${peerId}`;
  const video=document.createElement('video'); video.autoplay=true; video.playsInline=true; video.srcObject=stream;
  const label=document.createElement('div'); label.className='video-label'; label.textContent=username||peerId.substring(0,4);
  wrapper.appendChild(video); wrapper.appendChild(label); videoContainer.appendChild(wrapper);
  remoteVideos.set(peerId,wrapper);
}

function handleParticipantLeft(peerId){
  const pcData=peerConnections.get(peerId);
  if(pcData)pcData.pc.close();
  peerConnections.delete(peerId);
  const elem=remoteVideos.get(peerId);
  if(elem)elem.remove();
  remoteVideos.delete(peerId);
  updateParticipants();
}

startBtn.addEventListener('click',startCamera);
</script>
</body>
</html>
