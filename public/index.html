<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Video Chat</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif; background:#000; display:flex; height:100vh; overflow:hidden; }

  /* Sidebar */
  #sidebar { width:250px; background:#111; color:#fff; padding:10px; display:flex; flex-direction:column; overflow-y:auto; transition: all 0.3s ease; }
  #sidebar h2 { margin-bottom:10px; font-size:16px; text-align:center; }
  #sidebar ul { list-style:none; }
  #sidebar li { padding:8px; margin-bottom:5px; background:#222; border-radius:4px; cursor:pointer; }
  #sidebar li:hover { background:#333; }

  /* Main container */
  .main { flex:1; display:flex; flex-direction:column; align-items:center; padding:10px; overflow:auto; }
  .video-container { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:15px; width:100%; }
  .video-wrapper { position:relative; width:100%; padding-top:56.25%; background:#222; border-radius:8px; overflow:hidden; }
  video { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; }
  .video-label { position:absolute; bottom:5px; left:5px; background:rgba(0,0,0,0.6); color:#fff; padding:3px 6px; border-radius:4px; font-size:12px; }

  .controls { display:flex; gap:10px; margin:10px 0; flex-wrap:wrap; justify-content:center; }
  button { padding:8px 15px; border:none; border-radius:5px; cursor:pointer; font-weight:600; color:white; }
  #startBtn{background:#10b981;} #startBtn:hover{background:#059669;}
  #joinBtn{background:#3b82f6;} #joinBtn:hover{background:#2563eb;}
  #leaveBtn{background:#ef4444;} #leaveBtn:hover{background:#dc2626;}
  #toggleCamBtn{background:#f59e0b;} #toggleCamBtn:hover{background:#d97706;}
  button:disabled{opacity:0.5;cursor:not-allowed;}

  .status { color:#fff; margin-top:5px; font-size:14px; text-align:center; }
</style>
</head>
<body>

<div id="sidebar">
  <h2>Online Users</h2>
  <ul id="onlineList"></ul>
</div>

<div class="main">
  <div class="video-container" id="videoContainer">
    <div class="video-wrapper" id="localWrapper">
      <video id="localVideo" autoplay muted playsinline></video>
      <div class="video-label" id="localLabel">You</div>
    </div>
  </div>
  <div class="controls">
    <button id="startBtn">Start Camera</button>
    <button id="joinBtn" disabled>Join Call</button>
    <button id="leaveBtn" disabled>Leave Call</button>
    <button id="toggleCamBtn" disabled>Turn Camera Off</button>
  </div>
  <div class="status" id="status">Click "Start Camera" to begin</div>
</div>

<script>
const videoContainer = document.getElementById('videoContainer');
const localVideo = document.getElementById('localVideo');
const localLabel = document.getElementById('localLabel');
const localWrapper = document.getElementById('localWrapper');
const onlineList = document.getElementById('onlineList');

const startBtn = document.getElementById('startBtn');
const joinBtn = document.getElementById('joinBtn');
const leaveBtn = document.getElementById('leaveBtn');
const toggleCamBtn = document.getElementById('toggleCamBtn');
const status = document.getElementById('status');

let localStream;
let ws;
let myId;
let username;
let inCall = false;
let camOn = true;
const peerConnections = new Map();
const remoteVideos = new Map();

function updateStatus(msg){status.textContent=msg;}

async function startCamera(){
  username = prompt("Enter your name:");
  if(!username)return alert("You must enter a name!");
  try{
    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    localVideo.srcObject=localStream;
    localLabel.textContent=username;
    startBtn.disabled=true;
    toggleCamBtn.disabled=false;
    updateStatus("Camera started - connecting to server...");
    connectWebSocket();
  }catch(err){console.error(err); updateStatus("Error accessing camera/microphone");}
}

toggleCamBtn.addEventListener('click',()=>{
  camOn=!camOn;
  localStream.getVideoTracks()[0].enabled=camOn;
  toggleCamBtn.textContent=camOn?"Turn Camera Off":"Turn Camera On";
  if(!camOn){localVideo.style.display='none'; localWrapper.style.background='#'+Math.floor(Math.random()*16777215).toString(16);}
  else{localVideo.style.display='block'; localWrapper.style.background='#222';}
});

function connectWebSocket(){
  ws = new WebSocket('wss://your-app.onrender.com'); // <-- change to your render URL
  ws.onopen=()=>updateStatus('Connected to server');
  ws.onmessage=async(e)=>{
    const msg=JSON.parse(e.data);
    switch(msg.type){
      case 'welcome': myId=msg.id; joinBtn.disabled=false; updateStatus("Connected as "+username); break;
      case 'existing-participants': msg.participants.forEach(async id=>await createPeerConnection(id,true)); break;
      case 'new-participant': addOnlineUser(msg.id,msg.name); break;
      case 'user-left': removeOnlineUser(msg.id); break;
      case 'offer': await handleOffer(msg.offer,msg.from); break;
      case 'answer': await handleAnswer(msg.answer,msg.from); break;
      case 'ice-candidate': await handleIceCandidate(msg.candidate,msg.from); break;
    }
  };
  ws.onerror=()=>updateStatus("WebSocket error");
  ws.onclose=()=>updateStatus("Disconnected from server");
}

function addOnlineUser(id,name){
  if(document.getElementById('user-'+id)) return;
  const li=document.createElement('li');
  li.id='user-'+id;
  li.textContent=name;
  li.onclick=()=>startPrivateCall(id);
  onlineList.appendChild(li);
}

function removeOnlineUser(id){
  const li=document.getElementById('user-'+id);
  if(li)li.remove();
}

async function createPeerConnection(peerId,isInitiator){
  const pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  peerConnections.set(peerId,pc);
  localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
  pc.ontrack=(e)=>addRemoteVideo(peerId,e.streams[0]);
  pc.onicecandidate=(e)=>{if(e.candidate)ws.send(JSON.stringify({type:'ice-candidate',candidate:e.candidate,to:peerId}));};
  if(isInitiator){
    const offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    ws.send(JSON.stringify({type:'offer',offer,to:peerId}));
  }
  return pc;
}

async function handleOffer(offer,fromId){
  let pc=peerConnections.get(fromId);
  if(!pc) pc=await createPeerConnection(fromId,false);
  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);
  ws.send(JSON.stringify({type:'answer',answer,to:fromId}));
}

async function handleAnswer(answer,fromId){
  const pc=peerConnections.get(fromId);
  if(pc) await pc.setRemoteDescription(new RTCSessionDescription(answer));
}

async function handleIceCandidate(candidate,fromId){
  const pc=peerConnections.get(fromId);
  if(pc) await pc.addIceCandidate(new RTCIceCandidate(candidate));
}

function addRemoteVideo(peerId,stream){
  if(remoteVideos.has(peerId))return;
  const wrapper=document.createElement('div');
  wrapper.className='video-wrapper';
  wrapper.id='video-'+peerId;
  const video=document.createElement('video');
  video.autoplay=true; video.playsInline=true; video.srcObject=stream;
  const label=document.createElement('div'); label.className='video-label'; label.textContent='Participant '+peerId.substring(0,4);
  wrapper.appendChild(video); wrapper.appendChild(label); videoContainer.appendChild(wrapper);
  remoteVideos.set(peerId,wrapper);
}

function startPrivateCall(peerId){
  alert("Private call with user "+peerId+" clicked!"); 
  // TODO: implement private call logic
}

function joinCall(){ inCall=true; joinBtn.disabled=true; leaveBtn.disabled=false; ws.send(JSON.stringify({type:'join',
