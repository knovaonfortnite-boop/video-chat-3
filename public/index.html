<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini FaceTime Chat</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif; background:#000; min-height:100vh; display:flex; }
  .container { display:flex; width:100%; max-width:1400px; margin:auto; padding:20px; }
  .video-section { flex:4; display:grid; grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); gap:20px; }
  .video-wrapper { position:relative; background:#000; border-radius:12px; overflow:hidden; }
  video { width:100%; height:auto; display:block; min-height:300px; object-fit:cover; }
  .video-label { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.6); color:#fff; padding:6px 10px; border-radius:6px; font-size:14px; font-weight:500; }
  .controls { margin-top:20px; display:flex; gap:15px; flex-wrap:wrap; }
  button { padding:12px 30px; font-size:16px; border:none; border-radius:8px; cursor:pointer; font-weight:600; transition:all 0.3s ease; color:white; }
  #startBtn { background:#10b981; } #startBtn:hover { background:#059669; }
  #joinBtn { background:#3b82f6; } #joinBtn:hover { background:#2563eb; }
  #leaveBtn { background:#ef4444; } #leaveBtn:hover { background:#dc2626; }
  #toggleCamBtn { background:#f59e0b; } #toggleCamBtn:hover { background:#b45309; }
  button:disabled { opacity:0.5; cursor:not-allowed; transform:none; }
  .status { text-align:center; color:white; margin-top:10px; font-size:16px; padding:10px; background:rgba(255,255,255,0.1); border-radius:8px; }
  .sidebar { flex:1; background:#111; margin-left:20px; border-radius:8px; padding:10px; color:white; overflow-y:auto; max-height:80vh; }
  .user-item { padding:6px 10px; border-radius:6px; margin-bottom:5px; background:#222; cursor:pointer; }
  .user-item:hover { background:#333; }
</style>
</head>
<body>
<div class="container">
  <div class="video-section" id="videoContainer">
    <div class="video-wrapper" id="localWrapper">
      <video id="localVideo" autoplay muted playsinline></video>
      <div class="video-label" id="localLabel">You</div>
    </div>
    <div class="controls">
      <button id="startBtn">Start Camera</button>
      <button id="joinBtn" disabled>Join Call</button>
      <button id="leaveBtn" disabled>Leave Call</button>
      <button id="toggleCamBtn" disabled>Turn Camera Off</button>
    </div>
    <div class="status" id="status">Click "Start Camera" to begin</div>
  </div>
  <div class="sidebar" id="onlineUsers">
    <h3>Online Users</h3>
    <div id="userList"></div>
  </div>
</div>

<script>
const videoContainer = document.getElementById('videoContainer');
const localVideo = document.getElementById('localVideo');
const localLabel = document.getElementById('localLabel');
const localWrapper = document.getElementById('localWrapper');
const startBtn = document.getElementById('startBtn');
const joinBtn = document.getElementById('joinBtn');
const leaveBtn = document.getElementById('leaveBtn');
const toggleCamBtn = document.getElementById('toggleCamBtn');
const status = document.getElementById('status');
const userList = document.getElementById('userList');

let localStream;
let ws;
let myId;
let username;
let inCall = false;
let camOn = true;
const peerConnections = new Map();
const remoteVideos = new Map();
const onlineUsers = new Map();

const config = { iceServers:[{urls:'stun:stun.l.google.com:19302'}] };

function updateStatus(msg){status.textContent=msg;}

async function startCamera(){
  username = prompt("Enter your name:");
  if(!username) return alert("You must enter a name!");
  try{
    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    localVideo.srcObject = localStream;
    localLabel.textContent = username;
    startBtn.disabled = true;
    toggleCamBtn.disabled = false;
    updateStatus("Camera started - Connecting to server...");
    connectWebSocket();
  }catch(err){
    console.error(err);
    updateStatus("Error accessing camera/microphone");
  }
}

toggleCamBtn.addEventListener('click', ()=>{
  camOn = !camOn;
  localStream.getVideoTracks()[0].enabled = camOn;
  toggleCamBtn.textContent = camOn?"Turn Camera Off":"Turn Camera On";
  if(!camOn){
    localVideo.style.display='none';
    localWrapper.style.background='#'+Math.floor(Math.random()*16777215).toString(16);
  }else{
    localVideo.style.display='block';
    localWrapper.style.background='#000';
  }
});

// --- WebSocket & Peer Code ---
function connectWebSocket(){
  ws = new WebSocket('wss://your-server-url'); // <- REPLACE with your server
  ws.onopen=()=>{updateStatus("Connected to server"); ws.send(JSON.stringify({type:'register',username}))};
  ws.onmessage=async(e)=>{
    const msg=JSON.parse(e.data);
    switch(msg.type){
      case 'welcome': myId=msg.id; joinBtn.disabled=false; break;
      case 'update-users': updateOnlineUsers(msg.users); break;
      case 'offer': await handleOffer(msg.offer,msg.from); break;
      case 'answer': await handleAnswer(msg.answer,msg.from); break;
      case 'ice-candidate': await handleIceCandidate(msg.candidate,msg.from); break;
      case 'participant-left': handleParticipantLeft(msg.id); break;
    }
  };
  ws.onerror=()=>updateStatus("WebSocket error");
  ws.onclose=()=>updateStatus("Disconnected from server");
}

function updateOnlineUsers(users){
  userList.innerHTML='';
  users.forEach(u=>{
    if(u.id!==myId){
      const div=document.createElement('div');
      div.className='user-item';
      div.textContent=u.username;
      div.onclick=()=>startPrivateCall(u.id);
      userList.appendChild(div);
      onlineUsers.set(u.id,u.username);
    }
  });
}

// ...rest of peer connection functions: createPeerConnection, handleOffer, handleAnswer, handleIceCandidate, addRemoteVideo, handleParticipantLeft...

startBtn.addEventListener('click',startCamera);
joinBtn.addEventListener('click',()=>{/* join call code */});
leaveBtn.addEventListener('click',()=>{/* leave call code */});
</script>
</body>
</html>
